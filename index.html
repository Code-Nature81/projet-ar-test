<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Patrimoine AR - Collectivité</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; height: 100%;
    font-family: Arial, sans-serif;
    background: black;
    color: white;
  }
  #message {
    position: absolute;
    top: 10px; left: 10px; right: 10px;
    z-index: 10;
    background: rgba(0,0,0,0.5);
    padding: 10px;
    border-radius: 5px;
  }
  #ar-container {
    position: fixed;
    width: 100vw; height: 100vh;
    top: 0; left: 0;
    overflow: hidden;
  }
  video {
    position: absolute;
    width: 100vw; height: 100vh;
    object-fit: cover;
    z-index: 0;
  }
  canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    z-index: 1;
  }
</style>
</head>
<body>

<div id="message">Autorisez l'accès à la caméra et partagez votre position pour voir la bâtisse en réalité augmentée.</div>
<div id="ar-container"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

<script>
(async () => {
  const arContainer = document.getElementById('ar-container');
  const message = document.getElementById('message');

  // Coordonnées GPS cibles de la bâtisse (exemple Paris)
  const targetLat = 43.627806;
  const targetLon = 1.460011;
  const maxDistanceMeters = 50; // distance max pour afficher modèle

  // Fonction pour calculer la distance entre 2 points GPS (en mètres)
  function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000; // rayon Terre en mètres
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // Accès à la caméra (vidéo)
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' },
        audio: false
      });
      const video = document.createElement('video');
      video.setAttribute('playsinline', 'true');
      video.srcObject = stream;
      video.autoplay = true;
      video.muted = true;
      arContainer.appendChild(video);

      await new Promise(resolve => {
        video.onloadedmetadata = () => {
          video.play();
          resolve();
        };
      });

      return video;
    } catch (e) {
      message.innerText = "Erreur : accès caméra refusé ou indisponible.";
      throw e;
    }
  }

  // Initialiser three.js scène + caméra
  function initThree(video) {
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000, 0); // transparent
    arContainer.appendChild(renderer.domElement);

    const scene = new THREE.Scene();

    // Caméra "virtuelle"
    const camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 0, 0);

    // Lumière
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(0, 10, 10);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040, 2));

    return { renderer, scene, camera };
  }

  // Charger modèle GLB local
  async function loadModel(scene) {
    return new Promise((resolve, reject) => {
      const loader = new THREE.GLTFLoader();
      loader.load(
        'batiment.glb',
        gltf => {
          const model = gltf.scene;
          model.scale.set(0.5, 0.5, 0.5);
          model.position.set(0, 0, -3); // devant caméra
          scene.add(model);
          resolve(model);
        },
        undefined,
        error => {
          message.innerText = "Erreur de chargement du modèle 3D.";
          reject(error);
        }
      );
    });
  }

  // Animation loop
  function animate(renderer, scene, camera) {
    requestAnimationFrame(() => animate(renderer, scene, camera));
    renderer.render(scene, camera);
  }

  try {
    const video = await startCamera();

    // Demander position GPS
    if (!navigator.geolocation) {
      message.innerText = "Géolocalisation non supportée par ce navigateur.";
      return;
    }

    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude, longitude } = pos.coords;
      const distance = getDistanceFromLatLonInMeters(latitude, longitude, targetLat, targetLon);
      if (distance > maxDistanceMeters) {
        message.innerText = `Vous êtes trop loin de la bâtisse (distance: ${Math.round(distance)}m). Approchez-vous pour voir la réalité augmentée.`;
        return;
      }

      message.style.display = 'none'; // cacher message

      const { renderer, scene, camera } = initThree(video);
      const model = await loadModel(scene);

      animate(renderer, scene, camera);
    }, err => {
      message.innerText = "Erreur géolocalisation : " + err.message;
    }, {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    });
  } catch (e) {
    console.error(e);
  }
})();
</script>

</body>
</html>
