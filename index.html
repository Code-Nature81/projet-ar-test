<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR Patrimoine - Bâtisse 3D</title>
  <style>
    body, html {
      margin: 0; padding: 0; overflow: hidden; height: 100%; background: #000;
      font-family: Arial, sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #info {
      position: absolute;
      top: 10px; left: 10px; z-index: 10;
      background: rgba(0,0,0,0.5);
      padding: 10px; border-radius: 5px;
      max-width: 90vw;
    }
    #ar-container {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    video {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
    }
    canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="info">
    <p>Scannez le QR code sur place, autorisez la caméra et la géolocalisation.</p>
    <p>Une fois proche du point GPS, la bâtisse en 3D apparaît en réalité augmentée.</p>
  </div>

  <div id="ar-container"></div>

  <!-- Librairies three.js et GLTFLoader -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    // Coordonnées GPS du lieu où la bâtisse est reconstruite (exemple)
    const targetLatitude = 43.62773;  // Remplacer par la vraie latitude
    const targetLongitude = 1.45998;  // Remplacer par la vraie longitude

    // Distance max en mètres pour afficher le modèle 3D (ex: 20m)
    const maxDistance = 70;

    // Variables AR
    let scene, camera, renderer, model;
    let arContainer = document.getElementById('ar-container');

    // Fonction pour calculer distance entre 2 points GPS en mètres (Haversine formula)
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // rayon terre en mètres
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Initialisation Three.js
    function initThree() {
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 1000);
      camera.position.set(0, 1.6, 0); // Hauteur yeux moyenne

      renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000, 0); // transparent background
      arContainer.appendChild(renderer.domElement);

      // Lumière basique
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      light.position.set(0.5, 1, 0.25);
      scene.add(light);

      // Charger modèle 3D .glb optimisé (URL exemple)
      const loader = new THREE.GLTFLoader();
      loader.load(
        'https://github.com/Code-Nature81/projet-ar-test/blob/main/batiment.glb',
        function(gltf) {
          model = gltf.scene;
          model.scale.set(1,1,1);
          model.position.set(0, 0, -2); // 2m devant la caméra
          scene.add(model);
          model.visible = false; // invisible tant qu'on est pas au bon GPS
        },
        undefined,
        function(error) {
          console.error('Erreur chargement modèle:', error);
        }
      );

      animate();
    }

    // Animation boucle
    function animate() {
      requestAnimationFrame(animate);

      if (model) {
        model.rotation.y += 0.005; // petite rotation lente pour effet dynamique
      }

      renderer.render(scene, camera);
    }

    // Demande accès caméra vidéo en arrière-plan
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        const videoElem = document.createElement('video');
        videoElem.setAttribute('autoplay', '');
        videoElem.setAttribute('playsinline', '');
        videoElem.srcObject = stream;
        document.body.insertBefore(videoElem, arContainer);
        await videoElem.play();
      } catch(err) {
        alert('Impossible d\'accéder à la caméra : ' + err);
      }
    }

    // Vérification GPS et affichage modèle si proche
    function checkPosition(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const dist = getDistanceFromLatLonInMeters(lat, lon, targetLatitude, targetLongitude);

      if (model) {
        model.visible = dist <= maxDistance;
      }
    }

    // Démarrer géolocalisation en continu
    function startGeoWatch() {
      if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition(checkPosition, 
          (err) => alert('Erreur géolocalisation : ' + err.message),
          { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
        );
      } else {
        alert('Géolocalisation non supportée par votre navigateur');
      }
    }

    // Initialisation générale
    async function init() {
      await startCamera();
      initThree();
      startGeoWatch();
    }

    window.onload = init;

    window.addEventListener('resize', () => {
      if (renderer && camera) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    });
  </script>
</body>
</html>
